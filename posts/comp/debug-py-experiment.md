---
title: è°ƒè¯• Python å®éªŒä»£ç 
date: 2024-02-17
category: comp
tags:
  - python
keywords:
  - productivity
  - academia
status: tbc
---

é¢å‘å®éªŒä»£ç çš„ Python è°ƒè¯•æŠ€å·§ã€‚

<!-- more -->

## æ–­ç‚¹

é™¤å´é›†æˆå¼€å‘ç¯å¢ƒæä¾›çš„æ–­ç‚¹è°ƒè¯•ç•Œé¢ï¼ŒPython æä¾›äº†ä¸€ä¸ª[å†…ç½®å‡½æ•° `breakpoint`](https://docs.python.org/3/library/functions.html#breakpoint) å¯åŠ¨æ–­ç‚¹ã€‚åº•å±‚æ­¤å‡½æ•°å°†è°ƒç”¨ [`sys.breakpointhook`](https://docs.python.org/3/library/sys.html#sys.breakpointhook)ï¼Œé»˜è®¤æŒ‡å‘ `pdb.set_trace`ã€‚æ‰€ä»¥ï¼Œå¯ä»¥ä½¿ç”¨æ›´ç®€çŸ­çš„ä»£ç å¯åŠ¨è°ƒè¯•å™¨ï¼š

```python
# ä¸ä½¿ç”¨ breakpoint å‡½æ•°
import pdb; pdb.set_trace()

# ä¹‹å
breakpoint()
```

å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡ `PYTHONBREAKPOINT`ï¼ŒPython è§£é‡Šå™¨ä¼šè°ƒç”¨è¯¥å˜é‡æŒ‡å‘çš„å‡½æ•°ã€‚å› æ­¤å¯ä»¥è‡ªç”±åœ°æ›´æ¢è°ƒè¯•å™¨ï¼Œæ¯”å¦‚æ›´æ¢åˆ° [`ipdb`](#è°ƒè¯•å™¨)ã€‚

```python
os.environ["PYTHONBREAKPOINT"] = "ipdb.set_trace"
```

å¦‚æœè®¾ä¸ºç©ºï¼Œä»»ä½•æ–­ç‚¹å°†ä¼šè¢«å¿½ç•¥ã€‚å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œé¿å…åœ¨æœåŠ¡å™¨é›†ç¾¤çš„è„šæœ¬ä¸Šè§¦å‘æ–­ç‚¹ï¼š

```python
os.environ["PYTHONBREAKPOINT"] = "ipdb.set_trace" if sys.stdout.isatty() else ""
```

## å†…åµŒç»ˆç«¯

[IPython](https://ipython.org/) æ˜¯ä¸€ä¸ªäº¤äº’å¼çš„ Python REPLï¼Œæä¾›äº†ä»£ç é«˜äº®å’Œè¡¥å…¨ç­‰åŠŸèƒ½ã€‚å¯ä»¥ç”¨ä»¥ä¸‹ä»£ç åœ¨ç¨‹åºä¸­å¯åŠ¨ä¸€ä¸ª**å†…åµŒçš„äº¤äº’ç»ˆç«¯**ï¼Œå…¶å…¨å±€å‘½åç©ºé—´å°†ç»§æ‰¿è°ƒç”¨å¤„çš„å…¨å±€å’Œå±€éƒ¨å‘½åç©ºé—´ã€‚

```python
from IPython import embed; embed(using=False)
```

æ³¨æ„ï¼Œ`using` æ˜¯ä¸€ä¸ª[æ²¡åœ¨æ–‡æ¡£é‡Œå‡ºç°çš„å‚æ•°](https://github.com/ipython/ipython/blob/e60c06a57de9f1e53fdd4b3a16c6a16c530e4f2a/IPython/terminal/embed.py#L398)ï¼Œé»˜è®¤æ•ˆæœæ˜¯å…³é—­é«˜äº®å’Œå¼‚æ­¥è¿è¡Œæ—¶åŠŸèƒ½ï¼Œå¦‚æ­¤å¯ä»¥å¯ç”¨é«˜äº®ã€‚

ç‰¹åˆ«æ³¨æ„ï¼šå†…åµŒäº¤äº’ç»ˆç«¯çš„â€œå…¨å±€å‘½åç©ºé—´â€å®é™…ä¸Šå¹¶ä¸æ˜¯çœŸæ­£çš„å…¨å±€å‘½åç©ºé—´ï¼Œå› æ­¤è¯¸å¦‚é—­åŒ…ã€åœ¨ç»ˆç«¯å†…å®šä¹‰å…¨å±€å˜é‡ã€åµŒå¥—çš„ç”Ÿæˆå¼éƒ½ä¸èƒ½ä½¿ç”¨ï¼Œå³ä½¿å£°æ˜ `global` ä¹Ÿä¸è¡Œã€‚

è¯¦ç»†æ¥å£å¯ä»¥æŸ¥çœ‹[å…¶æ–‡æ¡£](https://ipython.readthedocs.io/en/stable/api/generated/IPython.terminal.embed.html)ã€‚å¯ä»¥å°†è¿™ä¸ªå†…åµŒç»ˆç«¯è®¾ä½œé»˜è®¤çš„æ–­ç‚¹é’©å­ã€‚

```python
os.environ=["PYTHONBREAKPOINT"] = "IPython.embed"
breakpoint(using=False)
```

å†…åµŒç»ˆç«¯æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„ IPython é­”æ³•æŒ‡ä»¤ï¼š`%exit_raise` å°†**å…³é—­ç»ˆç«¯å¹¶æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œç»ˆæ­¢å¤–éƒ¨ç¨‹åº**ï¼›è€Œ `%kill_embedded` åˆ™åœæ­¢æ­¤å¤„è°ƒç”¨åç»­çš„ç»ˆç«¯å”¤èµ·ï¼ˆæ¯”å¦‚åœ¨å¾ªç¯é‡Œå¯åŠ¨å†…åµŒç»ˆç«¯çš„æ—¶å€™ï¼‰ï¼ŒåŒæ—¶åŠ ä¸Šé€‰é¡¹ `-y` å¯ä»¥å…³é—­ç¡®è®¤é€€å‡ºæç¤º ã€‚

## è°ƒè¯•å™¨

è°ƒè¯•å™¨æä¾›äº†æ£€è§†å †æ ˆå¸§ï¼Œåˆ—å‡ºæºç åˆ—è¡¨ç­‰é«˜çº§åŠŸèƒ½ï¼Œè¿™æ˜¯å†…åµŒç»ˆç«¯æ‰€ä¸å…·å¤‡çš„ã€‚

ä¸€äº›å¸¸ç”¨çš„æŒ‡ä»¤ï¼š

```yaml
u(p): ä¸Šä¸€å±‚å †æ ˆ
d(own): ä¸‹ä¸€å±‚å †æ ˆ
interact: å¯åŠ¨äº¤äº’ç»ˆç«¯

s(tep): å•æ­¥è°ƒè¯•
n(ext): å½“å‰å‡½æ•°å†…å•æ­¥è°ƒè¯•  # ä¸ä¼šåœæ­¢åœ¨è°ƒç”¨çš„ä¸‹å±‚å‡½æ•°ä¸­
c(ontinue): ç»§ç»­è¿è¡Œ
r(eturn): ç»§ç»­è¿è¡Œåˆ°å‡½æ•°è¿”å›

l(ist): åˆ—å‡ºæºä»£ç 
j(ump): è·³åˆ°æŸä¸€è¡Œæ‰§è¡Œ

q(uit): é€€å‡º
```

[`ipdb`](#IPDB) æä¾›äº†ä¸€ä¸ªåŒ…å«ä»£ç é«˜äº®å’Œè¡¥å…¨ï¼Œç±»ä¼¼ IPython çš„è°ƒè¯•å™¨ï¼Œ**`interact` æŒ‡ä»¤å°†é»˜è®¤å¯ç”¨ IPython å†…åµŒç»ˆç«¯**ï¼ŒåŒæ—¶æš´éœ²äº†ä¸€äº›æ–¹ä¾¿è°ƒè¯•çš„æ¥å£ã€‚è¿™æ˜¯å•è¡Œçš„ç”¨æ³•ï¼š

```python
import ipdb; ipdb.set_trace()
```

åŒæ—¶æä¾›è‡ªåŠ¨æ•è·å¼‚å¸¸çš„è£…é¥°å™¨å’Œä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå¯ä»¥åˆ©ç”¨å®ƒä»¬ç®€åŒ–è°ƒè¯•ã€‚

```python
with ipdb.launch_ipdb_on_exception():
    ...

@ipdb.iex
def foo():
    ...
```

## è°ƒè¯•å¸¸é‡

Python å†…éƒ¨æœ‰ä¸€ä¸ªå¸¸é‡ `__debug__`ç”¨äºæ ‡è®°å½“å‰æ˜¯å¦ä¸ºè°ƒè¯•çŠ¶æ€ï¼Œ**é»˜è®¤ä¸ºçœŸ**ã€‚ä½¿ç”¨ `python -O`(O for Optimize) æˆ–ä¿®æ”¹ `PYTHONOPTIMIZE` ç¯å¢ƒå˜é‡å¯ä»¥å…³é—­è°ƒè¯•çŠ¶æ€ï¼Œæ­¤æ—¶ `assert` è¯­å¥å’Œä¾èµ– `__debug__` çš„ä»£ç å°†ä¸ä¼šè¿è¡Œã€‚ç›®å‰å®ƒä¸ä¼šå½±å“æ–­ç‚¹ï¼Œä½†å¯ä»¥åˆ©ç”¨è¿™ä¸ªåŠŸèƒ½ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼Œæ‰‹åŠ¨å…³é—­æ–­ç‚¹ã€‚

## æ–­è¨€

`assert` è¯­å¥æ¥å—ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¼šä½œä¸º `AssertionError` çš„å‚æ•°è¢«è°ƒç”¨ï¼Œå¯åœ¨è°ƒè¯•ä»£ç æ—¶ç”¨äºè¯´æ˜å¼‚å¸¸ç¼˜ç”±ã€‚

```python
assert (s := input_ids.shape[0]) == BATCH_SIZE, f"Got batch size {s}, {BATCH_SIZE} wanted"
```

å¯¹äºå®éªŒä»£ç æ¥è¯´ï¼Œæ–­è¨€æ¯”è¾ƒç®€ä¾¿ï¼ˆå®éªŒä¸­é€šå¸¸ä¸ä¼šæ•è·å¼‚å¸¸ï¼‰ï¼Œä¸”è‡ªå·±å†™çš„å¼‚å¸¸ç¼˜ç”±ä¼šæ¯”åº“æä¾›çš„åº•å±‚é”™è¯¯æ›´æ˜“è¯»ã€‚å¦‚æœå¯¹è‡ªå·±çš„ä»£ç æ²¡æœ‰æŠŠæ¡ï¼Œå°±åŠ ä¸Šæ–­è¨€ã€‚

## æ—¥å¿—

~~é™¤äº† JavaScript ä»¥å¤–~~ä½¿ç”¨ `print` è¿›è¡Œè°ƒè¯•å¹¶ä¸ç†æƒ³ã€‚å®ƒä¸å…·å¤‡è¾“å‡ºç¨‹åºå…ƒä¿¡æ¯çš„åŠŸèƒ½ï¼Œä¹Ÿä¸æ–¹ä¾¿æ‰¹é‡å…³é—­ï¼ˆè€Œæ—¥å¿—å¯ä»¥é€šè¿‡ä¿®æ”¹å…¨å±€æ—¥å¿—çº§åˆ«å…³é—­ä½çº§åˆ«çš„ä¿¡æ¯ï¼‰ã€‚å¯¹äºåœ¨é›†ç¾¤ä¸Šè¿è¡Œï¼ˆç”šè‡³é•¿æ—¶é—´è¿è¡Œï¼‰çš„ç¨‹åºæ¥è¯´ï¼Œå†™å…¥æ–‡ä»¶ç”šè‡³ç›´æ¥å‘æ‰‹æœºæ¨é€é€šçŸ¥å¯èƒ½æ¯”æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºæ›´é«˜æ•ˆä¸”æœ‰ç”¨ğŸ˜ã€‚

ä½† Python å†…ç½®çš„ [`logging`](https://docs.python.org/3/library/logging.html) æ¨¡å—è¿‡äºå¤æ‚ï¼Œé…ç½®éœ€è¦å†™å¤§é‡æ¨¡ç‰ˆä»£ç ã€‚`loguru` æ˜¯ä¸€ä¸ªä¸é”™çš„æ›¿ä»£å“ã€‚

> [!TBC]
> å…³äº `loguru` çš„ä½¿ç”¨å’Œé…ç½®
